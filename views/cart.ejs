<title>Cart- Iconica</title>
<%- include('./partials/header') %>

<div class="w-full min-h-screen px-20 py-16 bg-gray-100" style="font-family: Helvetica, Arial, sans-serif;">
    <h2 class="text-3xl font-semibold text-gray-800">Shopping Cart</h2>

    <% if (user.cart.length > 0) { %>
        <div class="flex gap-10 mt-8">
            <!-- Cart Items -->
            <div class="w-2/3 bg-white p-6 rounded-lg shadow-lg">
                <% user.cart.forEach(function(item, index){ %>
                    <div class="flex items-center gap-6 p-5 mb-6 border-b border-gray-300">
                        <!-- Product Image -->
                        <div class="w-40 h-40 flex items-center justify-center rounded-lg bg-[<%= item.bgcolor %>]">
                            <img class="h-[8rem]" src="data:image/jpeg;base64,<%= item.image.toString('base64') %>" alt="<%= item.name %>">
                        </div>

                        <!-- Product Details -->
                        <div class="flex-1">
                            <h3 class="text-xl font-medium text-gray-900"><%= item.name %></h3>
                            <p class="text-gray-500">Category: <%= item.category || "General" %></p>
                            <p class="text-lg text-gray-700 font-semibold mt-2">₹ <span id="price-<%= item._id %>"><%= item.price %></span></p>
                        </div>

                        <!-- Quantity Controls -->
                        <div class="flex items-center gap-4">
                            <button class="quantity-btn w-8 h-8 flex items-center justify-center bg-gray-200 rounded-full hover:bg-gray-300"
                                data-action="decrease" data-id="<%= item._id %>">
                                <i class="ri-subtract-line text-lg"></i>
                            </button>
                            <span id="quantity-<%= item._id %>" class="text-lg font-semibold px-4 py-2 bg-gray-200 rounded-md"><%= item.quantity || 1 %></span>
                            <button class="quantity-btn w-8 h-8 flex items-center justify-center bg-gray-200 rounded-full hover:bg-gray-300"
                                data-action="increase" data-id="<%= item._id %>">
                                <i class="ri-add-line text-lg"></i>
                            </button>
                        </div>
                    </div>
                <% }) %>
            </div>

            <!-- Price Breakdown & Checkout -->
            <div class="w-1/3 bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Price Breakdown</h3>

                <div class="space-y-3 text-gray-700">
                    <div class="flex justify-between">
                        <span>Total MRP</span>
                        <span>₹<span id="total-mrp"><%= user.cart.reduce((sum, item) => sum + Number(item.price) * (item.quantity || 1), 0) %></span></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Discount</span>
                        <span class="text-green-600">-₹<span id="total-discount"><%= user.cart.reduce((sum, item) => sum + Number(item.discount) * (item.quantity || 1), 0) %></span></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Platform Fee</span>
                        <span>₹20</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Shipping Fee</span>
                        <span class="text-green-600">FREE</span>
                    </div>
                </div>

                <hr class="my-4 border-gray-300">

                <div class="flex justify-between text-xl font-semibold text-gray-800">
                    <span>Total Amount</span>
                    <span class="text-green-600">₹ <span id="total-bill"><%= bill %></span></span>
                </div>

                <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg mt-5 text-lg font-semibold transition">
                    Proceed to Checkout
                </button>
            </div>
        </div>
    <% } else { %>
        <div class="w-full text-center py-20">
            <h3 class="text-2xl text-gray-700">Your cart is empty</h3>
            <a href="/shop" class="text-blue-600 hover:underline mt-4 inline-block">Continue Shopping</a>
        </div>
    <% } %>
</div>

<script>
document.querySelectorAll('.quantity-btn').forEach(button => {
    button.addEventListener('click', function() {
        const action = this.getAttribute('data-action');
        const itemId = this.getAttribute('data-id');
        
        fetch('/update-cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: itemId, action })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`quantity-${itemId}`).innerText = data.quantity;
                document.getElementById(`price-${itemId}`).innerText = data.price;
                document.getElementById('total-mrp').innerText = data.totalMRP;
                document.getElementById('total-discount').innerText = data.totalDiscount;
                document.getElementById('total-bill').innerText = data.bill;
            }
        })
        .catch(error => console.error('Error:', error));
    });
});
</script>

<%- include('./partials/footer') %>
